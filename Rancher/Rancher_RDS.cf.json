{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Sets up a Rancher RDS mysql db inside a VPC.",
  "Parameters": {
    "EnvironmentTag": {
      "Type": "String",
      "Default": "Production",
      "MinLength": "3",
      "MaxLength": "12",
      "AllowedPattern": "^[a-zA-Z]+$",
      "Description": "Enter the Name for the environment, this is used in tagging"
    },
    "VPCId": {
      "Type": "AWS::EC2::VPC::Id",
      "Description": "The VPC To deploy into"
    },
    "VPCCidr": {
      "Type": "String",
      "Description": "The Cidr of the VPC"
    },
    "PrivateHostedZone": {
      "Type": "AWS::Route53::HostedZone::Id",
      "Description": "The id of the hosted zone that we will put rancher into (this is usually a private hosted zone)"
    },
    "PrivateHostedZoneName": {
      "Type": "String",
      "Description": "The name of the hoseted zone for rancher (see PrivateHostedZone (do not add a trailing \".\")"
    },
    "DBSubnetGroupSubnetIds": {
      "Type": "List<AWS::EC2::Subnet::Id>",
      "Description": "The List of subnets for the subnet group of the database for high availability, (should be private.. if available)"
    },
    "RancherDBInstanceType": {
      "Type": "String",
      "Default": "db.t2.small",
      "AllowedValues": [
        "db.t2.small",
        "db.t2.medium",
        "db.m4.large"
      ],
      "Description": "Enter a size for the rancher database instance in the VPC from t2.small, m3.medium, or m4.large. Default is t2.small."
    },
    "RancherDBHostname": {
      "Type": "String",
      "Default": "rancher-db",
      "Description": "Enter a hostname for the database created by this template."
    },
    "RancherDBPort": {
      "Type": "String",
      "Default": "3306",
      "Description": "Enter a port for the database created by this template."
    },
    "RancherDBName": {
      "Type": "String",
      "MaxLength": "255",
      "MinLength": "1",
      "ConstraintDescription": "must begin with a letter and contain only alphanumeric characters.",
      "Default": "cattle",
      "Description": "Enter a database name for the DB created by this template."
    },
    "RancherDBUser": {
      "Type": "String",
      "MaxLength": "255",
      "MinLength": "1",
      "ConstraintDescription": "must begin with a letter and contain only alphanumeric characters.",
      "Default": "cattle",
      "Description": "Enter a name for the database user created by this template."
    },
    "RancherDBPassword": {
      "Type": "String",
      "NoEcho": "true",
      "MaxLength": "255",
      "MinLength": "4",
      "ConstraintDescription": "must contain atleast 4 characters.",
      "Description": "Enter a password for the database user created by this template."
    }
  },
  "Resources": {
    "RancherDBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupDescription": "The Rancher DB subnet group.",
        "SubnetIds": {
          "Ref": "DBSubnetGroupSubnetIds"
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentTag"
            }
          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${EnvironmentTag}.RancherDB.SubnetGroup"
            }
          }
        ]
      }
    },
    "RancherDB": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "AllocatedStorage": "20",
        "CopyTagsToSnapshot": "true",
        "DBInstanceClass": {
          "Ref": "RancherDBInstanceType"
        },
        "DBName": {
          "Ref": "RancherDBName"
        },
        "DBSubnetGroupName": {
          "Ref": "RancherDBSubnetGroup"
        },
        "Engine": "mysql",
        "EngineVersion": "5.7.11",
        "LicenseModel": "general-public-license",
        "MasterUsername": {
          "Ref": "RancherDBUser"
        },
        "MasterUserPassword": {
          "Ref": "RancherDBPassword"
        },
        "MultiAZ": "true",
        "Port": {
          "Ref": "RancherDBPort"
        },
        "PubliclyAccessible": "false",
        "Tags": [
          {
            "Key": "7mb:Env",
            "Value": {
              "Ref": "EnvironmentTag"
            }
          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${EnvironmentTag}.RancherDB"
            }
          }
        ],
        "VPCSecurityGroups": [
          {
            "Ref": "RancherDBSecurityGroup"
          }
        ]
      }
    },
    "RancherDBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for the Rancher DB layer.",
        "VpcId": {
          "Ref": "VPCId"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "icmp",
            "FromPort": "-1",
            "ToPort": "-1",
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": {
              "Ref": "RancherDBPort"
            },
            "ToPort": {
              "Ref": "RancherDBPort"
            },
            "CidrIp": {
              "Ref": "VPCCidr"
            }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "Tags": [
          {
            "Key": "7mb:Env",
            "Value": {
              "Ref": "EnvironmentTag"
            }
          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${EnvironmentTag}.SG.RancherDB"
            }
          }
        ]
      }
    },
    "RancherDBRecordSet": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneId": {
          "Ref": "PrivateHostedZone"
        },
        "Comment": "The private DNS record for the rancher database.",
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "RancherDBHostname"
              },
              ".",
              {
                "Ref": "PrivateHostedZoneName"
              },
              "."
            ]
          ]
        },
        "Type": "CNAME",
        "TTL": "900",
        "ResourceRecords": [
          {
            "Fn::GetAtt": [
              "RancherDB",
              "Endpoint.Address"
            ]
          }
        ]
      }
    }
  }
}