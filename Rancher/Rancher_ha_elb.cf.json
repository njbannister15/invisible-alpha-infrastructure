{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Sets up a Rancher RDS mysql db inside a VPC.",
  "Parameters": {
    "Instances": {
      "Type": "List<AWS::EC2::Instance::Id>",
      "Description": "List of ec2 rancher instances to load balance across"
    },
    "InstancePort": {
      "Type": "String",
      "Default": "8080",
      "Description": "The port that the instances are exposing"
    },
    "CertARN": {
      "Type": "String",
      "Description": "The ARN of the certification to use."
    },
    "PublicHostedZone": {
      "Type": "AWS::Route53::HostedZone::Id",
      "Description": "The id of the hosted zone that we will put rancher elb into (this is usually a public hosted zone)"
    },
    "PublicHostedZoneName": {
      "Type": "String",
      "Description": "The name id of the hosted zone that we will put rancher elb into (this is usually a public hosted zone), ex rancher.example.com"
    },
    "Subnets": {
      "Type": "List<AWS::EC2::Subnet::Id>",
      "Description": "The List of subnets "
    },
    "SecurityGroups": {
      "Type": "List<AWS::EC2::SecurityGroup::Id>",
      "Description": "List of Security groups for the elb"
    }
  },
  "Resources": {
    "ElasticLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties": {
        "Subnets": {
          "Ref": "Subnets"
        },
        "Instances": {
          "Ref": "Instances"
        },
        "Listeners": [
          {
            "LoadBalancerPort": "443",
            "InstancePort": {
              "Ref": "InstancePort"
            },
            "Protocol": "SSL",
            "InstanceProtocol": "TCP",
            "SSLCertificateId": {
              "Ref": "CertARN"
            }
          }
        ],
        "Policies": [
          {
            "PolicyName": "ELBSecurityPolicyName",
            "PolicyType": "SSLNegotiationPolicyType",
            "Attributes": [
              {
                "Name": "Reference-Security-Policy",
                "Value": "ELBSecurityPolicy-2016-08"
              }
            ]
          },
          {
            "PolicyName": "EnableProxyProtocol",
            "PolicyType": "ProxyProtocolPolicyType",
            "Attributes": [
              {
                "Name": "ProxyProtocol",
                "Value": "true"
              }
            ],
            "InstancePorts": [{
              "Ref": "InstancePort"
            }]
          }
        ],
        "HealthCheck": {
          "Target": {
            "Fn::Join": [
              "",
              [
                "HTTP:",
                {
                  "Ref": "InstancePort"
                },
                "/ping"
              ]
            ]
          },
          "HealthyThreshold": "3",
          "UnhealthyThreshold": "5",
          "Interval": "30",
          "Timeout": "5"
        },
        "SecurityGroups": {
          "Ref": "SecurityGroups"
        }
      }
    },
    "RancherInstanceRecordSet": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneId": {
          "Ref": "PublicHostedZone"
        },
        "Comment": "The private DNS record for the rancher instance.",
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "PublicHostedZoneName"
              },
              "."
            ]
          ]
        },
        "Type": "A",
        "AliasTarget": {
          "DNSName": {
            "Fn::GetAtt": [
              "ElasticLoadBalancer",
              "DNSName"
            ]
          },
          "HostedZoneId": {
            "Fn::GetAtt": [
              "ElasticLoadBalancer",
              "CanonicalHostedZoneNameID"
            ]
          }
        }
      }
    }
  }
}